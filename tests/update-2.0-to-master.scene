devel enable salt=True, manifests=True

cluster tfvars images-2.1
cluster tfvars tests/update-2.0-to-master

stage apply
print ###############################################
print # creating cluster
print ###############################################

cluster create
sleep 30

# wait for nodes to be accepted
salt wait
ctl minions accepted
sleep 30

cluster snapshot stage="post-create"
sleep 30

stage orch
print ###############################################
print # bootstrapping in 2.0
print ###############################################
cluster rollback

# check nodes->dashboard connectivity before going further
# (this will abort the script if it fails)
ssh nodes "ping -c1 dashboard"

# run the regular bootstrap orchestration
devel branch salt release-2.0
devel branch manifests release-2.0
salt wait
orch boot
sleep 30

cluster snapshot stage="post-orch-2.0", description="Orchestration 2.0 has been run. Update to MASTER will be done now."
sleep 30

stage update
print ###############################################
print # updating the cluster to current worktree
print ###############################################
cluster rollback

# run an update
devel branch salt RESET
devel branch manifests RESET
salt wait
orch update fake=True
sleep 30
